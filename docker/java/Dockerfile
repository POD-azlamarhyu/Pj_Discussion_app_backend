FROM gradle:8.13.0-jdk21-corretto AS build

ARG BUILD_WORKDIR
ARG JAVA_CONTAINER_USER
ARG JAVA_CONTAINER_USER_ID

RUN if ! getent group ${JAVA_CONTAINER_USER_ID} > /dev/null 2>&1; then \
        groupadd -g ${JAVA_CONTAINER_USER_ID} ${JAVA_CONTAINER_USER}; \
    fi && \
    if ! id -u ${JAVA_CONTAINER_USER_ID} > /dev/null 2>&1; then \ 
        useradd -u ${JAVA_CONTAINER_USER_ID} -g ${JAVA_CONTAINER_USER} -m ${JAVA_CONTAINER_USER}; \
    fi && \
    useradd -g ${JAVA_CONTAINER_USER_ID} -m ${JAVA_CONTAINER_USER}

WORKDIR ${BUILD_WORKDIR}

COPY --chown=${JAVA_CONTAINER_USER_ID}:${JAVA_CONTAINER_USER_ID} gradlew build.gradle settings.gradle ./
COPY --chown=${JAVA_CONTAINER_USER_ID}:${JAVA_CONTAINER_USER_ID} gradle ./gradle

RUN ./gradlew dependencies --no-daemon || true

COPY --chown=gradle:gradle . ${BUILD_WORKDIR}/
RUN ./gradlew clean build -x test --no-daemon


FROM eclipse-temurin:21.0.5_11-jre-jammy AS deploy
ARG API_PORT
ARG DEPLOY_WORKDIR
ARG JAVA_CONTAINER_USER
ARG JAVA_CONTAINER_USER_ID
ARG APP_NAME
ARG BUILD_WORKDIR
ARG SPRING_PROFILES_ACTIVE
ENV ENTRY_DEPLOY_WORKDIR ${DEPLOY_WORKDIR}
ENV ENTRY_APP_NAME ${APP_NAME}
ENV SPRING_PROFILES_ACTIVE ${SPRING_PROFILES_ACTIVE}

WORKDIR ${DEPLOY_WORKDIR}

COPY --from=build --chown=${JAVA_CONTAINER_USER_ID}:${JAVA_CONTAINER_USER_ID} "${BUILD_WORKDIR}/build/libs/${APP_NAME}" ./

USER ${JAVA_CONTAINER_USER_ID}

EXPOSE ${API_PORT}

CMD sh -c "java -jar ${DEPLOY_WORKDIR}/${APP_NAME}"
