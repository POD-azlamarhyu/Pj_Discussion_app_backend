FROM gradle:8.13.0-jdk21-corretto AS build

ARG BUILD_WORKDIR
ARG JAVA_CONTAINER_USER
ARG JAVA_CONTAINER_USER_ID

USER ${JAVA_CONTAINER_USER_ID}
WORKDIR ${BUILD_WORKDIR}
COPY --chown=gradle:gradle . ${BUILD_WORKDIR}/
RUN ./gradlew clean build


FROM eclipse-temurin:21.0.5_11-jre-jammy AS deploy
ARG API_PORT
ARG DEPLOY_WORKDIR
ARG JAVA_CONTAINER_USER
ARG JAVA_CONTAINER_USER_ID
ARG APP_NAME
ARG BUILD_WORKDIR
ENV ENTRY_DEPLOY_WORKDIR ${DEPLOY_WORKDIR}
ENV ENTRY_APP_NAME ${APP_NAME}
ENV SPRING_PROFILES_ACTIVE=dev

WORKDIR ${DEPLOY_WORKDIR}

COPY --from=build "${BUILD_WORKDIR}/build/libs/${APP_NAME}" .
COPY . ${DEPLOY_WORKDIR}/
EXPOSE 8080
CMD sh -c "java -jar ${DEPLOY_WORKDIR}/${APP_NAME}
